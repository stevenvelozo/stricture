# Docuserve Configuration Files

pict-docuserve is a single-page documentation viewer that consumes several
configuration files to build its navigation, splash page, top bar and search.
These files are typically generated by Indoctrinate from the Stricture model
but can also be authored by hand.

All files are served from the docs root (the same folder as the docuserve
application).

## Configuration Files Overview

| File                       | Required | Purpose                                |
|----------------------------|----------|----------------------------------------|
| `retold-catalog.json`      | No       | Master catalog of module groups        |
| `_sidebar.md`              | No       | Markdown sidebar navigation            |
| `cover.md`                 | No       | Splash page content                    |
| `_topbar.md`               | No       | Top bar branding and navigation links  |
| `errorpage.md`             | No       | Custom 404 error page                  |
| `retold-keyword-index.json`| No       | Lunr.js search index for full-text search |

All files are optional. Docuserve operates in three modes depending on
which files are present:

- **Catalog mode** -- `retold-catalog.json` drives the sidebar and document
  resolution via raw GitHub URLs
- **Markdown mode** -- `_sidebar.md`, `cover.md` and `_topbar.md` override
  the catalog-derived navigation
- **Standalone mode** -- if no catalog or sidebar is found, docuserve
  auto-discovers a `README.md` and creates minimal navigation

## retold-catalog.json

The master catalog defines the project name, GitHub organization, module
groups and individual modules with their documentation structure.

### Top-Level Fields

| Field           | Type   | Required | Description                            |
|-----------------|--------|----------|----------------------------------------|
| `Name`          | string | Yes      | Display name of the documentation project |
| `Description`   | string | Yes      | Project description                    |
| `GitHubOrg`     | string | Yes      | GitHub organization (used to build raw GitHub URLs) |
| `DefaultBranch` | string | Yes      | Default git branch for fetching docs   |
| `Generated`     | string | No       | ISO timestamp of when the catalog was generated |
| `Groups`        | array  | Yes      | Array of module group objects           |

### Group Object

| Field         | Type   | Required | Description                            |
|---------------|--------|----------|----------------------------------------|
| `Key`         | string | Yes      | Unique identifier for the group (used in routes) |
| `Name`        | string | Yes      | Display name shown in the sidebar      |
| `Description` | string | Yes      | Group description                      |
| `Modules`     | array  | Yes      | Array of module objects                 |

### Module Object

| Field      | Type    | Required | Description                            |
|------------|---------|----------|----------------------------------------|
| `Name`     | string  | Yes      | Module name (used in routes and sidebar) |
| `Repo`     | string  | Yes      | GitHub repository name                  |
| `Group`    | string  | Yes      | Parent group key (must match group's `Key`) |
| `Branch`   | string  | Yes      | Git branch for this module (overrides `DefaultBranch`) |
| `HasDocs`  | boolean | Yes      | Whether documentation exists           |
| `Sidebar`  | array   | Yes      | Module-specific navigation entries      |

### Document URL Resolution

Docuserve constructs document URLs using:

```
https://raw.githubusercontent.com/{GitHubOrg}/{Module.Repo}/{Module.Branch}/docs/{docPath}
```

### Example

```json
{
    "Name": "Retold",
    "Description": "A suite of JavaScript/Node.js modules for building web applications",
    "GitHubOrg": "stevenvelozo",
    "DefaultBranch": "master",
    "Generated": "2024-01-15T10:30:00.000Z",
    "Groups": [
        {
            "Key": "fable",
            "Name": "Fable",
            "Description": "Core ecosystem: dependency injection, configuration, logging",
            "Modules": [
                {
                    "Name": "fable",
                    "Repo": "fable",
                    "Group": "fable",
                    "Branch": "master",
                    "HasDocs": true,
                    "Sidebar": [
                        {
                            "Title": "Getting Started",
                            "Path": "getting-started.md"
                        },
                        {
                            "Title": "API Reference",
                            "Children": [
                                {
                                    "Title": "Core API",
                                    "Path": "api/core.md"
                                },
                                {
                                    "Title": "Services",
                                    "Path": "api/services.md"
                                }
                            ]
                        }
                    ]
                },
                {
                    "Name": "fable-log",
                    "Repo": "fable-log",
                    "Group": "fable",
                    "Branch": "master",
                    "HasDocs": false,
                    "Sidebar": []
                }
            ]
        },
        {
            "Key": "meadow",
            "Name": "Meadow",
            "Description": "Data access layer: ORM, query DSL, schema definitions",
            "Modules": [
                {
                    "Name": "meadow",
                    "Repo": "meadow",
                    "Group": "meadow",
                    "Branch": "master",
                    "HasDocs": true,
                    "Sidebar": []
                }
            ]
        }
    ]
}
```

## Module Sidebar Structure

Each module's `Sidebar` array defines the in-module navigation that appears
when a user is viewing that module's documentation. Entries can be flat links
or grouped under section headings.

### Flat Entry

A direct link to a document:

```json
{
    "Title": "Getting Started",
    "Path": "getting-started.md"
}
```

### Grouped Entry

A section heading with child links:

```json
{
    "Title": "API Reference",
    "Children": [
        { "Title": "Core API", "Path": "api/core.md" },
        { "Title": "Services", "Path": "api/services.md" }
    ]
}
```

### Entry Fields

| Field      | Type   | Required | Description                            |
|------------|--------|----------|----------------------------------------|
| `Title`    | string | Yes      | Display text for the navigation entry  |
| `Path`     | string | No       | Document path relative to module's docs folder |
| `Children` | array  | No       | Sub-entries (renders as a section with child links) |

Routes are constructed as `#/doc/{group}/{module}/{Path}`.

## cover.md

The cover page defines the splash/homepage content. It follows a
docsify-inspired markdown convention.

### Format

```markdown
# Project Title
> Tagline or subtitle text

Description paragraph. Displayed as introductory text on the splash page.

- **Feature Name** — Feature description
- **Another Feature** — Another description

[Get Started](getting-started.md)
[View on GitHub](https://github.com/org/repo)
```

### Parsing Rules

| Element                       | Parsed As           | Notes                       |
|-------------------------------|---------------------|-----------------------------|
| `# Heading`                   | `Title`             | First heading found         |
| `> Blockquote`                | `Tagline`           | First blockquote found      |
| Plain paragraph text          | `Description`       | Concatenated if multi-line  |
| `- **Label** — text`          | `Highlights` entry  | Bold label with separator   |
| `- Plain bullet text`         | `Highlights` entry  | Label is empty              |
| `[Link Text](url)` (bare line)| `Actions` button   | Only bare links on their own line |

### Resulting Structure

```json
{
    "Title": "Project Title",
    "Tagline": "Tagline or subtitle text",
    "Description": "Description paragraph...",
    "Highlights": [
        { "Label": "Feature Name", "Text": "Feature description" },
        { "Label": "Another Feature", "Text": "Another description" }
    ],
    "Actions": [
        { "Text": "Get Started", "Href": "getting-started.md" },
        { "Text": "View on GitHub", "Href": "https://github.com/org/repo" }
    ]
}
```

## _sidebar.md

An optional markdown file that overrides the catalog-derived sidebar
navigation. When present, its structure replaces the sidebar groups
built from the catalog.

### Format

```markdown
- [Home](/)
- Getting Started
  - [Installation](installation.md)
  - [Quick Start](quick-start.md)
- Fable
  - [fable](/fable/fable/)
  - [fable-log](/fable/fable-log/)
- Guides
  - [Configuration](configuration.md)
```

### Parsing Rules

- **Top-level items** (no indent) become groups
- **Indented items** (2+ leading spaces) become modules within the
  preceding group
- A link `[Text](href)` at top level creates a group with a route
- Plain text at top level creates a group header with no route
- Indented links create module entries with `HasDocs: true`
- Indented plain text creates module entries with `HasDocs: false`

### Link Resolution

| Sidebar Link Format      | Converted Route          |
|--------------------------|--------------------------|
| `/`                      | `#/Home`                 |
| `/fable/fable/`          | `#/doc/fable/fable`      |
| `/fable/fable/api.md`    | `#/doc/fable/fable/api.md` |
| `installation.md`        | `#/page/installation`    |
| `guides/advanced`        | `#/page/guides/advanced` |

Links starting with a catalog group key are routed as `#/doc/...` (resolved
via raw GitHub URLs). All other links are routed as `#/page/...` (fetched
locally).

## _topbar.md

An optional markdown file that defines the top navigation bar.

### Format

```markdown
# Retold
- [Docs](/)
- [Guides](guides.md)
- [GitHub](https://github.com/stevenvelozo/retold)
```

### Parsing Rules

| Element                    | Parsed As                | Position  |
|----------------------------|--------------------------|-----------|
| `# Heading`                | `Brand` (site title)     | Left      |
| `- [Text](internal-link)`  | `NavLinks` entry         | Center    |
| `- [Text](https://...)`    | `ExternalLinks` entry    | Right     |

### Resulting Structure

```json
{
    "Brand": "Retold",
    "NavLinks": [
        { "Text": "Docs", "Href": "#/Home" },
        { "Text": "Guides", "Href": "#/page/guides" }
    ],
    "ExternalLinks": [
        { "Text": "GitHub", "Href": "https://github.com/stevenvelozo/retold" }
    ]
}
```

## errorpage.md

An optional markdown file displayed when a document cannot be found.

### Format

Standard markdown with an optional `{{path}}` placeholder:

```markdown
# Page Not Found

The document `{{path}}` could not be loaded.

Please check the URL or [return to the home page](/).
```

The `{{path}}` token is replaced at display time with the actual requested
path (HTML-escaped for security). If no `errorpage.md` is provided,
docuserve uses a built-in default not-found page.

## retold-keyword-index.json

An optional Lunr.js search index that enables full-text search across all
module documentation. This file is typically generated by Indoctrinate.

### Structure

| Field           | Type   | Description                                |
|-----------------|--------|--------------------------------------------|
| `LunrIndex`     | object | Serialized Lunr.js index (loaded via `lunr.Index.load()`) |
| `Documents`     | object | Map of document keys to metadata objects   |
| `DocumentCount` | number | Total number of indexed documents          |

### Document Metadata

Each key in `Documents` is a document identifier in the format
`{group}/{module}` or `{group}/{module}/{docpath}`:

| Field     | Type   | Description                        |
|-----------|--------|------------------------------------|
| `Title`   | string | Display name of the document       |
| `Group`   | string | Group key                          |
| `Module`  | string | Module name                        |
| `DocPath` | string | Path relative to module docs folder |

### Example

```json
{
    "LunrIndex": {
        "version": "2.3.9",
        "fields": ["title", "body"],
        "fieldVectors": [],
        "invertedIndex": [],
        "pipeline": ["stemmer"]
    },
    "Documents": {
        "fable/fable": {
            "Title": "Fable",
            "Group": "fable",
            "Module": "fable",
            "DocPath": "README.md"
        },
        "meadow/meadow": {
            "Title": "Meadow",
            "Group": "meadow",
            "Module": "meadow",
            "DocPath": "README.md"
        }
    },
    "DocumentCount": 2
}
```

## Hash Routing

Docuserve uses hash-based routing. All navigation links are converted to
hash routes by the provider and application.

| Route Pattern                        | Handler            | Description                 |
|--------------------------------------|--------------------|-----------------------------|
| `#/Home`                             | Splash view        | Show cover page             |
| `#/search/{query}`                   | Search view        | Full-text search results    |
| `#/page/{path}`                      | Page view          | Local markdown document     |
| `#/doc/{group}/{module}`             | Module view        | Module README via GitHub    |
| `#/doc/{group}/{module}/{docpath}`   | Module path view   | Specific doc within module  |

### Link Resolution Within Documents

Links in rendered markdown documents are automatically resolved:

| Link in Markdown                        | Resolved Route                         |
|-----------------------------------------|----------------------------------------|
| `api.md` (relative, within module)      | `#/doc/{group}/{module}/api.md`        |
| `./settings.md` (relative, dot prefix)  | `#/doc/{group}/{module}/settings.md`   |
| `/fable/fable/` (absolute, catalog group) | `#/doc/fable/fable`                 |
| `https://github.com/{org}/{repo}`       | `#/doc/{group}/{module}` if in catalog |
| `architecture.md` (no module context)   | `#/page/architecture`                  |

GitHub URLs that match the catalog's `GitHubOrg` and a module's `Repo` are
automatically converted to internal docuserve routes.
